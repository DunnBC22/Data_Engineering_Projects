-- Database name: home_insurance_ds_db
-- owner: airflow

-- Create temp_table to manipulate the data column format
CREATE TEMPORARY TABLE temp_table (
    id INTEGER,
    COVER_START VARCHAR,
    CLAIM3YEARS VARCHAR,
    P1_EMP_STATUS VARCHAR,
    BUS_USE VARCHAR,
    AD_BUILDINGS VARCHAR,
    RISK_RATED_AREA_B FLOAT,
    SUM_INSURED_BUILDINGS FLOAT,
    NCD_GRANTED_YEARS_B FLOAT,
    AD_CONTENTS VARCHAR,
    RISK_RATED_AREA_C FLOAT,
    SUM_INSURED_CONTENTS FLOAT,
    NCD_GRANTED_YEARS_C FLOAT,
    CONTENTS_COVER VARCHAR,
    BUILDINGS_COVER VARCHAR,
    SPEC_SUM_INSURED FLOAT,
    SPEC_ITEM_PREM FLOAT,
    UNSPEC_HRP_PREM FLOAT,
    P1_DOB VARCHAR,
    P1_MAR_STATUS VARCHAR,
    P1_POLICY_REFUSED VARCHAR,
    P1_SEX VARCHAR,
    APPR_ALARM VARCHAR,
    APPR_LOCKS VARCHAR,
    BEDROOMS FLOAT,
    ROOF_CONSTRUCTION FLOAT,
    WALL_CONSTRUCTION FLOAT,
    FLOODING VARCHAR,
    LISTED FLOAT,
    MAX_DAYS_UNOCC FLOAT,
    NEIGH_WATCH VARCHAR,
    OCC_STATUS VARCHAR,
    OWNERSHIP_TYPE FLOAT,
    PAYING_GUESTS FLOAT,
    PROP_TYPE INTEGER,
    SAFE_INSTALLED VARCHAR,
    SEC_DISC_REQ VARCHAR,
    SUBSIDENCE VARCHAR,
    YEARBUILT INTEGER,
    PAYMENT_METHOD VARCHAR,
    LEGAL_ADDON_PRE_REN VARCHAR,
    LEGAL_ADDON_POST_REN VARCHAR,
    HOME_EM_ADDON_PRE_REN VARCHAR,
    HOME_EM_ADDON_POST_REN VARCHAR,
    GARDEN_ADDON_PRE_REN VARCHAR,
    GARDEN_ADDON_POST_REN VARCHAR,
    KEYCARE_ADDON_PRE_REN VARCHAR,
    KEYCARE_ADDON_POST_REN VARCHAR,
    HP1_ADDON_PRE_REN VARCHAR,
    HP1_ADDON_POST_REN VARCHAR,
    HP2_ADDON_PRE_REN VARCHAR,
    HP2_ADDON_POST_REN VARCHAR,
    HP3_ADDON_PRE_REN VARCHAR,
    HP3_ADDON_POST_REN VARCHAR,
    MTA_FLAG VARCHAR,
    LAST_ANN_PREM_GROSS FLOAT,
    POL_STATUS VARCHAR,
    Police VARCHAR
);

-- Create main table
DROP TABLE IF EXISTS home_insurance_ds;

CREATE TABLE home_insurance_ds (
    id INTEGER,
    COVER_START DATE,
    CLAIM3YEARS VARCHAR,
    P1_EMP_STATUS VARCHAR,
    BUS_USE VARCHAR,
    AD_BUILDINGS VARCHAR,
    RISK_RATED_AREA_B FLOAT,
    SUM_INSURED_BUILDINGS FLOAT,
    NCD_GRANTED_YEARS_B FLOAT,
    AD_CONTENTS VARCHAR,
    RISK_RATED_AREA_C FLOAT,
    SUM_INSURED_CONTENTS FLOAT,
    NCD_GRANTED_YEARS_C FLOAT,
    CONTENTS_COVER VARCHAR,
    BUILDINGS_COVER VARCHAR,
    SPEC_SUM_INSURED FLOAT,
    SPEC_ITEM_PREM FLOAT,
    UNSPEC_HRP_PREM FLOAT,
    P1_DOB DATE,
    P1_MAR_STATUS VARCHAR,
    P1_POLICY_REFUSED VARCHAR,
    P1_SEX VARCHAR,
    APPR_ALARM VARCHAR,
    APPR_LOCKS VARCHAR,
    BEDROOMS FLOAT,
    ROOF_CONSTRUCTION FLOAT,
    WALL_CONSTRUCTION FLOAT,
    FLOODING VARCHAR,
    LISTED FLOAT,
    MAX_DAYS_UNOCC FLOAT,
    NEIGH_WATCH VARCHAR,
    OCC_STATUS VARCHAR,
    OWNERSHIP_TYPE FLOAT,
    PAYING_GUESTS FLOAT,
    PROP_TYPE INTEGER,
    SAFE_INSTALLED VARCHAR,
    SEC_DISC_REQ VARCHAR,
    SUBSIDENCE VARCHAR,
    YEARBUILT INTEGER,
    PAYMENT_METHOD VARCHAR,
    LEGAL_ADDON_PRE_REN VARCHAR,
    LEGAL_ADDON_POST_REN VARCHAR,
    HOME_EM_ADDON_PRE_REN VARCHAR,
    HOME_EM_ADDON_POST_REN VARCHAR,
    GARDEN_ADDON_PRE_REN VARCHAR,
    GARDEN_ADDON_POST_REN VARCHAR,
    KEYCARE_ADDON_PRE_REN VARCHAR,
    KEYCARE_ADDON_POST_REN VARCHAR,
    HP1_ADDON_PRE_REN VARCHAR,
    HP1_ADDON_POST_REN VARCHAR,
    HP2_ADDON_PRE_REN VARCHAR,
    HP2_ADDON_POST_REN VARCHAR,
    HP3_ADDON_PRE_REN VARCHAR,
    HP3_ADDON_POST_REN VARCHAR,
    MTA_FLAG VARCHAR,
    LAST_ANN_PREM_GROSS FLOAT,
    POL_STATUS VARCHAR,
    Police VARCHAR
);

-- Copy in data to temp table to allow for 
-- manipulating format of date columns
COPY temp_table(
    id,
    COVER_START,
    CLAIM3YEARS,
    P1_EMP_STATUS,
    BUS_USE,
    AD_BUILDINGS,
    RISK_RATED_AREA_B,
    SUM_INSURED_BUILDINGS,
    NCD_GRANTED_YEARS_B,
    AD_CONTENTS,
    RISK_RATED_AREA_C,
    SUM_INSURED_CONTENTS,
    NCD_GRANTED_YEARS_C,
    CONTENTS_COVER,
    BUILDINGS_COVER,
    SPEC_SUM_INSURED,
    SPEC_ITEM_PREM,
    UNSPEC_HRP_PREM,
    P1_DOB,
    P1_MAR_STATUS,
    P1_POLICY_REFUSED,
    P1_SEX,
    APPR_ALARM,
    APPR_LOCKS,
    BEDROOMS,
    ROOF_CONSTRUCTION,
    WALL_CONSTRUCTION,
    FLOODING,
    LISTED,
    MAX_DAYS_UNOCC,
    NEIGH_WATCH,
    OCC_STATUS,
    OWNERSHIP_TYPE,
    PAYING_GUESTS,
    PROP_TYPE,
    SAFE_INSTALLED,
    SEC_DISC_REQ,
    SUBSIDENCE,
    YEARBUILT,
    PAYMENT_METHOD,
    LEGAL_ADDON_PRE_REN,
    LEGAL_ADDON_POST_REN,
    HOME_EM_ADDON_PRE_REN,
    HOME_EM_ADDON_POST_REN,
    GARDEN_ADDON_PRE_REN,
    GARDEN_ADDON_POST_REN,
    KEYCARE_ADDON_PRE_REN,
    KEYCARE_ADDON_POST_REN,
    HP1_ADDON_PRE_REN,
    HP1_ADDON_POST_REN,
    HP2_ADDON_PRE_REN,
    HP2_ADDON_POST_REN,
    HP3_ADDON_PRE_REN,
    HP3_ADDON_POST_REN,
    MTA_FLAG,
    LAST_ANN_PREM_GROSS,
    POL_STATUS,
    Police
    )
FROM '/Users/briandunn/Desktop/Projects 2/Home Insurance Dataset/Final Dataset.csv'
DELIMITER ','
CSV HEADER;

-- Update the format of the COVER_START column
UPDATE temp_table
SET COVER_START = TO_DATE(COVER_START, 'DD-MM-YYYY');

-- Update the format of the P1_DOB column
UPDATE temp_table
SET P1_DOB = TO_DATE(P1_DOB, 'DD-MM-YYYY');

-- insert data with correct date format into main table
INSERT INTO home_insurance_ds (
    id,
    COVER_START,
    CLAIM3YEARS,
    P1_EMP_STATUS,
    BUS_USE,
    AD_BUILDINGS,
    RISK_RATED_AREA_B,
    SUM_INSURED_BUILDINGS,
    NCD_GRANTED_YEARS_B,
    AD_CONTENTS,
    RISK_RATED_AREA_C,
    SUM_INSURED_CONTENTS,
    NCD_GRANTED_YEARS_C,
    CONTENTS_COVER,
    BUILDINGS_COVER,
    SPEC_SUM_INSURED,
    SPEC_ITEM_PREM,
    UNSPEC_HRP_PREM,
    P1_DOB,
    P1_MAR_STATUS,
    P1_POLICY_REFUSED,
    P1_SEX,
    APPR_ALARM,
    APPR_LOCKS,
    BEDROOMS,
    ROOF_CONSTRUCTION,
    WALL_CONSTRUCTION,
    FLOODING,
    LISTED,
    MAX_DAYS_UNOCC,
    NEIGH_WATCH,
    OCC_STATUS,
    OWNERSHIP_TYPE,
    PAYING_GUESTS,
    PROP_TYPE,
    SAFE_INSTALLED,
    SEC_DISC_REQ,
    SUBSIDENCE,
    YEARBUILT,
    PAYMENT_METHOD,
    LEGAL_ADDON_PRE_REN,
    LEGAL_ADDON_POST_REN,
    HOME_EM_ADDON_PRE_REN,
    HOME_EM_ADDON_POST_REN,
    GARDEN_ADDON_PRE_REN,
    GARDEN_ADDON_POST_REN,
    KEYCARE_ADDON_PRE_REN,
    KEYCARE_ADDON_POST_REN,
    HP1_ADDON_PRE_REN,
    HP1_ADDON_POST_REN,
    HP2_ADDON_PRE_REN,
    HP2_ADDON_POST_REN,
    HP3_ADDON_PRE_REN,
    HP3_ADDON_POST_REN,
    MTA_FLAG,
    LAST_ANN_PREM_GROSS,
    POL_STATUS,
    Police
    ) 
    SELECT 
        id,
        COVER_START::DATE,
        CLAIM3YEARS,
        P1_EMP_STATUS,
        BUS_USE,
        AD_BUILDINGS,
        RISK_RATED_AREA_B,
        SUM_INSURED_BUILDINGS,
        NCD_GRANTED_YEARS_B,
        AD_CONTENTS,
        RISK_RATED_AREA_C,
        SUM_INSURED_CONTENTS,
        NCD_GRANTED_YEARS_C,
        CONTENTS_COVER,
        BUILDINGS_COVER,
        SPEC_SUM_INSURED,
        SPEC_ITEM_PREM,
        UNSPEC_HRP_PREM,
        P1_DOB::DATE,
        P1_MAR_STATUS,
        P1_POLICY_REFUSED,
        P1_SEX,
        APPR_ALARM,
        APPR_LOCKS,
        BEDROOMS,
        ROOF_CONSTRUCTION,
        WALL_CONSTRUCTION,
        FLOODING,
        LISTED,
        MAX_DAYS_UNOCC,
        NEIGH_WATCH,
        OCC_STATUS,
        OWNERSHIP_TYPE,
        PAYING_GUESTS,
        PROP_TYPE,
        SAFE_INSTALLED,
        SEC_DISC_REQ,
        SUBSIDENCE,
        YEARBUILT,
        PAYMENT_METHOD,
        LEGAL_ADDON_PRE_REN,
        LEGAL_ADDON_POST_REN,
        HOME_EM_ADDON_PRE_REN,
        HOME_EM_ADDON_POST_REN,
        GARDEN_ADDON_PRE_REN,
        GARDEN_ADDON_POST_REN,
        KEYCARE_ADDON_PRE_REN,
        KEYCARE_ADDON_POST_REN,
        HP1_ADDON_PRE_REN,
        HP1_ADDON_POST_REN,
        HP2_ADDON_PRE_REN,
        HP2_ADDON_POST_REN,
        HP3_ADDON_PRE_REN,
        HP3_ADDON_POST_REN,
        MTA_FLAG,
        LAST_ANN_PREM_GROSS,
        POL_STATUS,
        Police
    FROM temp_table;